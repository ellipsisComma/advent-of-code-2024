// Advent of Code 2024 day 6

const input = `........................#........#................#.............#..#....#.#.#.........#........##..................#..#...........
.#........#......##........#.................................................#.#.........#......#.................................
...........#.#.##.#.........#.#..#............#.....................................................#.............#...............
..........#...............#......#...............#.#..............................#..........#........#..#...##.........#..#......
..........................................................#...........................................#...........................
................#.....#.............#...........................................................#.....#..........#...#...##.......
.....................#......#....................#..................#.....................#................................#......
......#........#.........#.....................................#......................#...........#................#.......#......
.........#.......#...#..................##.#...#...........#.......#............#...#....#...........#................#...........
..........................................#..........................#........#.....##............#.........................#.....
..........#...................##.......#.............#....##..............#.........#..............#........#..........#....#.....
.#....##........#.....................................#...#.............................#..............#.....#....................
....#..#................................................#.......#..........#.....#.....#..........................................
.............##...............#..........#...............................................#............#..............#..##....#...
......#...............#...............#.........................................................................#.#..............#
......#........................................................................................#.......#.....#................#...
.......#..#...#.............................#......#.....#........................................#.........................#..##.
.................................#..................#.......#......#...................#...................#.......#............#.
......#....................#.........................#........................................................#...#.......#..#..#.
..##....#...............................#.................#....#........#......#..........#....#........#..................#......
..................#..........#................................#.........#...........#..#......#.....................#.............
##.................................................#..............#....#...............#..........................................
....#..............#.............#..........................................................................#................#....
..................................................#...#..#.......#................................................#...........#...
.....#.......#...............................................................#......#.....#......................................#
....#....................##....................#............#................................#..#....#....#..........#............
.#.........................#.....................#..........................##............................................#.......
.......................#.........................................#................................................................
...............#........................................................................#..........#.............................#
.#..............................#..#....................#........................#......#.#......#.......#....................#..#
..........................#........#.........#.........#...#..#................#........#.........................#...............
..#.................................#.........#......................#............................................................
...........................#..............................................#.................#...............#.....................
..........#..................#.............................................#.......................#..............................
....................#............##..........................#...............#..........#.......................................#.
....................#....#.....................................................................#.................................#
....#.......#...................#....#.#....#..................................#.#....#..#.............................#.....##...
.............#.#...................................................................#........#..............................#......
.......................#.....................#.......#.........................................#..........#.......................
...............#..............#..................................#.............#..................................................
......................................................................................#........#......................#.....#.....
.........#.....................................................#................#..........................#........###...........
...................#..##...............#......................#...................................................................
.............#........................................#..................................#.#.#....................................
......#............#.........................#..........#..#.................................................................##...
............#...............#..................................#...........#...............................#...........#..........
................#.......#.......................#................#.............#................................#.................
.........................#.#.........#..#.....#.....................................#................................#............
..#...............#..#..........................#.#.....#....................#....................................................
................................................................................#..........#..............#.......................
............#.#......#......#........#..................#...#.....................................................................
....#......................#........................#..................#......#.....#.............................................
.#..................#...........................#..........#..........................................#....#......................
...............#......................#.......#.....#...#.................#...............................................#.......
#...#.......#..............................................................................................#...........#......#...
........................#......................#..........#...............................##......#...........................#...
....................#....#..............#.....#.....#................#............................................................
................#........................................................................................#........................
...##................#.............#..............................................................................................
.#....#........................................................................................................................##.
..#...................................#......#.#......#...................#........#.............................#....##..........
.......................................................#..#....#..#.................................................#.............
............#..................#......#.....#...........................................................#..#........#............#
..#................................#....................................................................#.............#......#....
..#..........#........#..............................................................................................#............
.....#.....................#..............#.................................#................................#...#................
........................#........#..................................................................................#.............
...#...........#.............................................#....................#....#..........#...............................
...................#...........#...................................................................#...........#..................
...........#............................#......................................................................................##.
#..............#.#.......................................#.......................#.....#...........#.......#...........#.##.......
..............................................................##.........................................#.............#.........#
...........................#.#..................................................#..................#..#...........................
.....................................#...............#.....#...................................#..................................
..#...................#.#....#...#......................................................#.#..................................#....
..........................................#......................................................................#................
.............#...................................................................#...#....#........#...................#..........
.......................#.......................................##...........#......#......#..............................#........
.......#..............#..............#..............................................................#............................#
...........................................#...#.......#......#...............................#.........#.........................
.......#...................................................#........................^..#..........................................
.#..........................................................................................#.......#.#..#........................
............................##........................................................................#..#........................
..........#.#..#....#.##........................#.................................................................................
......#.#...................................#...#...................#.............#.....#.........................................
.................#........................................................................................#..#.#..................
#....................#.......................................#..#..#.....#..............#......................................#..
..............#.#............................................................#.....#......................................#......#
....................#.......#.............................#..............#.........................................##.............
.....#................................#.#...........#...........#.......................................#...#....#................
...............#...#......................#............................#..................................#.......................
....#........##...............................................................#......#...#.........#.....#..................#.....
...............................#......................................................................#...........................
............................#.............................#........##...............#................#....#...#..............#....
.......................#................#.......#........................................................................#........
..................................................................................#......................#.......#.#..............
........#.........................#........#.........................#.......................#......................#......#......
.........................#..#...........#..#.......................#.#.................#..........................................
......#.................#......................................................................#........................#.........
......................................##..........#...........................#........#...........#..............................
.......................................#...........................#.........#....#................#...............#..............
...........#...........#.........................#.......#.................#....#.#...........#..................#.##...........#.
...#..................#..#...............#..#...................................#.......#................#...................#....
...............#............#.......#.............#............#......###.............#.............................#..........#..
.......................................#...........................................#........#...........#.........................
................#...........#.....#..#...........##..................##..........#....#.....#...#........#........................
...............................##.............................................................#..........#...#....#...............
............#.................#...##.........#.......................................................................#............
...........#.#............................#...............##...........................................#............#....#........
...............................................#...........................................#..........#......................#....
......................................#........................................#.....................##...........#.....#..#.#....
..............................#.......#...#.#...............................................................................##....
................##......#..#.......#...........#............#.#......#..#................#..#.....#..................##...........
#.....#...........................#....................#.........................................................................#
............#.............#........#........#.#...............#...........................#.........#.............#......#........
#...#.........#.....#...................................................#.........................................................
.....................#...........#....................#.....#............##..........#....#..........#......#..........#..........
...................................#.........#.....#.................................#..........................................#.
......................................................#.........#.................................................................
...............#..............#........................................................................##.......#.............##..
...............#.......#.........#.........................#.......................##.............................................
..................#....................................#......................................................##...#....#.......#.
..#........#.....#...............#...............................#.........................#.#........#....#......................
..#.............#.......##...#......#....................................................................................#........
............................#.......#...........#.............#.............#..........................#..........................
.............#........................#........................................................#.........#........................
.#............#.....#...........................................#..#............................#..............#..........#.......
................#.....................................#..............................#............................................
..................#........................................#.#.................................................................#..
.#............#.......#..................................#....#.................................................#..............#.#`;

// move the guard-agent around the map according to the rules, modifying spaces they visit and adding first-time visits to a "visited" tally until the agent leaves the map (or a turn limit is reached)
function initialiseGuard() {
	guard.dir = 0;
	guard.pos.x = guard.initPos.x;
	guard.pos.y = guard.initPos.y;
}

const move = [
	{"x": 0, "y": -1}, // up
	{"x": 1, "y": 0}, // right
	{"x": 0, "y": 1}, // down
	{"x": -1, "y": 0}, // left
];
const siteMapOriginal = input.split(`\n`).map(row => row.split(``));
const siteMap1 = structuredClone(siteMapOriginal);
const yMax = siteMap1.length;
const xMax = siteMap1[0].length;
const guard = {
	"dir": 0,
	"initPos": {
		"x": 0,
		"y": 0,
	},
	"pos": {
		"x": 0,
		"y": 0,
	},
};
let visited = 1;

let foundInitial = false;
for (let y = 0; y < yMax; y++) {
	for (let x = 0; x < xMax; x++) {
		if (siteMap1[y][x] === `^`) {
			guard.pos.x = x;
			guard.pos.y = y;
			guard.initPos.x = x;
			guard.initPos.y = y;
			foundInitial = true;
		}
		if (foundInitial) break;
	}
	if (foundInitial) break;
}

siteMap1[guard.pos.y][guard.pos.x] = `X`;
const maxTurns = 1000000;
let turn = 0;
while (++turn < maxTurns) {
	const next = {
		"x": guard.pos.x + move[guard.dir].x,
		"y": guard.pos.y + move[guard.dir].y,
	};
	if (
		next.x < 0
		|| next.x >= xMax
		|| next.y < 0
		|| next.y >= yMax
	) break;
	else if (siteMap1[next.y][next.x] === `#`) guard.dir = (guard.dir + 1) % move.length;
	else {
		guard.pos.x += move[guard.dir].x;
		guard.pos.y += move[guard.dir].y;
		if (siteMap1[next.y][next.x] === `.`) {
			visited++;
			siteMap1[next.y][next.x] = `X`;
		}
	}
}

console.log(`unique visited spaces: ${visited}`);

// repeat the agent-exploration process for every possible version of the map that has one additional obstacle added to an initially-empty space, ending the simulation and recording an infinite loop if the agent ever has an identical position and direction as on a previous turn in the same simulation

let loopObstacles = 0;

// encode two non-negative integers as their Szudzik pair
function elegantPair(a, b) {
	return a >= b ? (a * a) + a + b : (b * b) + a;
}

for (let y = 0; y < yMax; y++) {
	for (let x = 0; x < xMax; x++) {
		if (siteMapOriginal[y][x] !== `.`) continue;

		initialiseGuard();
		let turn = 0;
		// clone sitemap and add new obstacle
		const siteMap2 = structuredClone(siteMapOriginal);
		siteMap2[y][x] = `#`;

		// create new set of history entities
		const history = new Set();
		history.add(elegantPair(guard.dir, elegantPair(guard.pos.x, guard.pos.y)));
		while (++turn < maxTurns) {
			const next = {
				"x": guard.pos.x + move[guard.dir].x,
				"y": guard.pos.y + move[guard.dir].y,
			};
			if (
				next.x < 0
				|| next.x >= xMax
				|| next.y < 0
				|| next.y >= yMax
			) break;
			else if (siteMap2[next.y][next.x] === `#`) guard.dir = (guard.dir + 1) % move.length;
			else {
				guard.pos.x += move[guard.dir].x;
				guard.pos.y += move[guard.dir].y;
				const newHistory = elegantPair(guard.dir, elegantPair(guard.pos.x, guard.pos.y));
				if (history.has(newHistory)) {
					loopObstacles++;
					break;
				} else history.add(newHistory);
			}
		}
	}
}

console.log(`count of obstacles that cause infinite loops: ${loopObstacles}`);
